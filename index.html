<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Image Map Annotator ‚Äî 2048√ó1365 Export (Fix Flip)</title>

    <!-- Leaflet core -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet.draw -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }
      #map {
        background: #0b0f17;
      }
      .toolbar {
        position: absolute;
        z-index: 1000;
        right: 12px;
        top: 12px;
        background: rgba(11, 15, 23, 0.85);
        color: #e5e7eb;
        border: 1px solid #1f2937;
        border-radius: 14px;
        padding: 12px;
        font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;
        backdrop-filter: blur(6px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        display: grid;
        gap: 8px;
        min-width: 280px;
      }
      .btn {
        border: 1px solid #374151;
        background: #111827;
        color: #e5e7eb;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn:hover {
        background: #0b1220;
      }
      input[type="text"],
      input[type="number"] {
        border: 1px solid #374151;
        background: #0b0f17;
        color: #e5e7eb;
        border-radius: 10px;
        padding: 7px 10px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      small {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="toolbar" id="ui">
      <div class="row">
        <strong>Basemap:</strong> <code>./base_map.png</code> (2048√ó1365)
      </div>
      <div class="row">
        <label>Stroke px</label>
        <input
          id="strokeW"
          type="number"
          value="3"
          min="1"
          max="40"
          style="width: 90px"
        />
        <label>Fill Œ±</label>
        <input
          id="fillA"
          type="number"
          value="0.25"
          min="0"
          max="1"
          step="0.05"
          style="width: 90px"
        />
        <button class="btn" id="applyStyle">Terapkan</button>
      </div>
      <div class="row">
        <button id="fit" class="btn">üîé Zoom ke Gambar</button>
        <button id="clear" class="btn">üßπ Bersihkan</button>
      </div>
      <div class="row">
        <input
          id="filename"
          type="text"
          placeholder="Nama file (opsional)"
          style="flex: 1"
        />
        <label
          ><input id="bgToggle" type="checkbox" checked /> Sertakan
          basemap</label
        >
      </div>
      <button id="export" class="btn">‚¨áÔ∏è Ekspor PNG (2048√ó1365)</button>
      <small
        >Gunakan toolbar Leaflet di kiri atas untuk menggambar/ubah/hapus
        poligon/persegi.</small
      >
    </div>

    <script>
      // ---- Konstanta resolusi & path ----
      const IMG_W = 2048;
      const IMG_H = 1365;
      const IMG_PATH = "./base_map.png";

      // ---- Inisialisasi peta CRS.Simple ----
      // Catatan: CRS.Simple menganggap lat = -y, lng = x
      const map = L.map("map", {
        crs: L.CRS.Simple,
        preferCanvas: true,
        zoomControl: true,
        minZoom: -5,
        zoomSnap: 0.5,
        zoomDelta: 0.5,
        wheelDebounceTime: 40,
        wheelPxPerZoomLevel: 96,
      });

      // Bounds yang benar untuk CRS.Simple: [[0,0], [-H, W]]
      const bounds = [
        [0, 0],
        [-IMG_H, IMG_W],
      ];
      const overlay = L.imageOverlay(IMG_PATH, bounds, {
        interactive: false,
      }).addTo(map);
      map.setMaxBounds(bounds);
      map.fitBounds(bounds, { animate: false });

      // ---- Layer gambar & kontrol menggambar ----
      const drawnItems = new L.FeatureGroup().addTo(map);

      let shapeOptions = { color: "#00e0ff", weight: 3, fillOpacity: 0.25 };
      let drawControl = new L.Control.Draw({
        position: "topleft",
        draw: {
          polygon: { allowIntersection: false, showArea: true, shapeOptions },
          rectangle: { shapeOptions },
          polyline: false,
          circle: false,
          circlemarker: false,
          marker: false,
        },
        edit: { featureGroup: drawnItems, remove: true },
      });
      map.addControl(drawControl);

      map.on(L.Draw.Event.CREATED, (e) => drawnItems.addLayer(e.layer));

      // ---- UI actions ----
      document.getElementById("fit").addEventListener("click", () => {
        map.fitBounds(bounds);
      });

      document.getElementById("clear").addEventListener("click", () => {
        if (confirm("Hapus semua poligon?")) drawnItems.clearLayers();
      });

      document.getElementById("applyStyle").addEventListener("click", () => {
        const strokeW = clamp(
          parseFloat(document.getElementById("strokeW").value) || 3,
          1,
          40
        );
        const fillA = clamp(
          parseFloat(document.getElementById("fillA").value) || 0.25,
          0,
          1
        );
        shapeOptions = {
          color: "#00e0ff",
          weight: strokeW,
          fillOpacity: fillA,
        };

        // Perbarui kontrol draw
        map.removeControl(drawControl);
        drawControl = new L.Control.Draw({
          position: "topleft",
          draw: {
            polygon: { allowIntersection: false, showArea: true, shapeOptions },
            rectangle: { shapeOptions },
            polyline: false,
            circle: false,
            circlemarker: false,
            marker: false,
          },
          edit: { featureGroup: drawnItems, remove: true },
        });
        map.addControl(drawControl);

        // Perbarui layer yang sudah ada
        drawnItems.eachLayer((l) => {
          if (l.setStyle) l.setStyle(shapeOptions);
        });
      });

      document.getElementById("export").addEventListener("click", async () => {
        const includeBg = document.getElementById("bgToggle").checked;
        const nameInput = document.getElementById("filename").value.trim();
        const filename = nameInput
          ? nameInput.replace(/\.(png|jpe?g|webp)$/i, "")
          : "annotated-map";

        const out = document.createElement("canvas");
        out.width = IMG_W;
        out.height = IMG_H;
        const ctx = out.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        if (includeBg) {
          await drawBackground(ctx, IMG_PATH, IMG_W, IMG_H);
        } else {
          ctx.clearRect(0, 0, IMG_W, IMG_H);
        }

        // ‚ú® KONVERSI BENAR: pixelX = lng, pixelY = -lat
        const strokeW = shapeOptions.weight;
        const fillA = shapeOptions.fillOpacity;
        drawnItems.eachLayer((layer) => {
          if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
            drawPolygonLayer(ctx, layer, strokeW, fillA, "#00e0ff");
          }
        });

        const a = document.createElement("a");
        a.download = `${filename}.png`;
        a.href = out.toDataURL("image/png");
        a.click();

        // ---- Internal helpers ----
        function drawPolygonLayer(ctx, layer, strokeW, fillA, hexColor) {
          const parts = layer.getLatLngs();
          ctx.save();
          ctx.lineWidth = strokeW;
          ctx.strokeStyle = hexColor;
          ctx.fillStyle = hexToRgba(hexColor, fillA);

          const drawRing = (ring) => {
            ctx.beginPath();
            for (let i = 0; i < ring.length; i++) {
              const px = ring[i].lng; // x = lng
              const py = -ring[i].lat; // y = -lat  (FIX TERBALIK)
              if (i === 0) ctx.moveTo(px, py);
              else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
          };

          const first = parts[0];
          if (Array.isArray(first) && Array.isArray(first[0])) {
            parts.forEach((ring) => drawRing(ring));
          } else {
            parts.forEach((ring) => drawRing(ring));
          }
          ctx.restore();
        }
      });

      // ---- Helpers ----
      function drawBackground(ctx, src, w, h) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, w, h);
            resolve();
          };
          img.onerror = () => resolve();
          img.src = src;
        });
      }

      function hexToRgba(hex, a) {
        const m = hex.replace("#", "");
        const s =
          m.length === 3
            ? m
                .split("")
                .map((c) => c + c)
                .join("")
            : m;
        const int = parseInt(s, 16);
        const r = (int >> 16) & 255,
          g = (int >> 8) & 255,
          b = int & 255;
        return `rgba(${r},${g},${b},${a})`;
      }
      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      // (Opsional) cegah klik di toolbar ikut nge-trigger map
      L.DomEvent.disableClickPropagation(document.getElementById("ui"));
    </script>
  </body>
</html>
